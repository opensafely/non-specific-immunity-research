--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\cohorts\non-specific-immunity-research\log/00_Test_runs_and_feasibility.log
  log type:  text
 opened on:  13 Nov 2020, 12:29:00

. *log using "C:\Users\EIDEDGRI\Documents\GitHub\non-specific-immunity-research\logs\test_log", replace t
. 
. * Import dataset into STATA
. import delimited "output/input.csv", clear
(64 vars, 23,313,603 obs)

. 
. *cd C:\Users\EIDEDGRI\Documents\GitHub\non-specific-immunity-research
. *import delimited output/input.csv, clear
. 
. * Keep test variables
. keep patient_id age sgss_covid_test_ever* covid_anytest* covid_negtest covid_tpp_probable

. 
. set linesize 200

. 

. 
. * How many covid_anytests?
. summ covid_anytest_count, d

                     covid_anytest_count
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0              0
 5%            0              0
10%            0              0       Obs          23,313,603
25%            0              0       Sum of Wgt.    23313603

50%            0                      Mean           .0094423
                        Largest       Std. Dev.       .146483
75%            0             12
90%            0             12       Variance       .0214573
95%            0             12       Skewness       17.99238
99%            0             12       Kurtosis       404.0927

. 
. 
. /* === Age groups === */ 
. 
. * Create categorised age 
. recode age 0/9.9999 = 1 ///
>                    10/17.9999 = 2 ///
>                    18/29.9999 = 3 /// 
>                    30/39.9999 = 4 /// 
>            40/49.9999 = 5 ///
>                    50/59.9999 = 6 ///
>                60/69.9999 = 7 ///
>                    70/79.9999 = 8 ///
>                    80/max = 9, gen(agegroup) 
(23078422 differences between age and agegroup)

. 
. label define agegroup   1 "<10" ///
>                                                 2 "10-<18" ///
>                                                 3 "18-<30" ///
>                                                 4 "30-<40" ///
>                                                 5 "40-<50" ///
>                                                 6 "50-<60" ///
>                                                 7 "60-<70" ///
>                                                 8 "70-<80" ///
>                                                 9 "80+"

.                                                 
. label values agegroup agegroup

. 
. tab agegroup

  RECODE of |
        age |      Freq.     Percent        Cum.
------------+-----------------------------------
         -1 |         REDACTED        0.00        0.00
        <10 |  2,532,133       10.86       10.86
     10-<18 |  2,131,796        9.14       20.01
     18-<30 |  3,407,361       14.62       34.62
     30-<40 |  3,281,546       14.08       48.70
     40-<50 |  3,041,067       13.04       61.74
     50-<60 |  3,210,402       13.77       75.51
     60-<70 |  2,504,137       10.74       86.25
     70-<80 |  2,017,288        8.65       94.90
        80+ |  1,187,870        5.10      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00

. 
. 
. /* === Dates === */
. 
. ds, has(type string)
covid_tpp_~e  sgss_covid~e  covid_an~rst  covid_an~ast  covid_negt~t

. 
. * Recode to dates from the strings 
. foreach var of varlist `r(varlist)' {
  2.                                                 
.         confirm string variable `var'
  3.         rename `var' `var'_dstr
  4.         gen `var' = date(`var'_dstr, "YMD")
  5.         format `var' %td
  6.         
.         *Week of year
.         gen `var'_eflag=1 if !inlist(year(`var'),2020,.)
  7.         gen `var'_week=week(`var') if year(`var')==2020
  8.         
.         * XXX Year_flag indicates error in dates XXX
.         tab `var'_eflag, m
  9. }
(23,042,674 missing values generated)
(23,313,222 missing values generated)
(23,043,055 missing values generated)

covid_tpp_p |
robable_efl |
         ag |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        381        0.00        0.00
          . | 23,313,222      100.00      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00
(19,263,761 missing values generated)
(23,313,603 missing values generated)
(19,263,761 missing values generated)

sgss_covid_ |
test_ever_d |
  ate_eflag |      Freq.     Percent        Cum.
------------+-----------------------------------
          . | 23,313,603      100.00      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00
(23,136,812 missing values generated)
(23,313,575 missing values generated)
(23,136,840 missing values generated)

covid_anyte |
st_first_ef |
        lag |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         28        0.00        0.00
          . | 23,313,575      100.00      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00
(23,136,812 missing values generated)
(23,313,578 missing values generated)
(23,136,837 missing values generated)

covid_anyte |
st_last_efl |
         ag |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         25        0.00        0.00
          . | 23,313,578      100.00      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00
(20,629,612 missing values generated)
(23,313,526 missing values generated)
(20,629,689 missing values generated)

covid_negte |
   st_eflag |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         77        0.00        0.00
          . | 23,313,526      100.00      100.00
------------+-----------------------------------
      Total | 23,313,603      100.00

. 
. 
. /* === Frequency of covid tests === */
. 
. * ##### COVID TPP positive tests #####
. table covid_tpp_probable_week agegroup, contents(count covid_tpp_probable) row col

----------------------------------------------------------------------------------------------------
covid_tpp |
_probable |                                      RECODE of age                                      
_week     |     <10   10-<18   18-<30   30-<40   40-<50   50-<60   60-<70   70-<80      80+    Total
----------+-----------------------------------------------------------------------------------------
        REDACTED 1-10
       11 |      40        7       81       79       70       95       59       72       76      579
       12 |      71       25       88      152      150      214      177      210      241    1,328
       13 |      62       26      171      272      340      504      474      521      649    3,019
       14 |      52       36      209      367      625      960      853    1,020    1,413    5,535
       15 |      35       22      223      420      566      906      727      889    1,232    5,020
       16 |      73       43      344      505      723      988      873      983    1,554    6,086
       17 |      43       38      498      655      886    1,143      714      778    1,518    6,273
       18 |      59       65      793      924    1,170    1,402      825      768    1,591    7,597
       19 |      70      100      688      719      850    1,004      648      640    1,407    6,126
       20 |      87      109      658      670      766      812      534      484    1,057    5,177
       21 |      74       93      546      548      574      712      406      351      632    3,936
       22 |      70      105      468      465      423      566      337      398      665    3,497
       23 |      84      111      427      441      475      457      314      268      482    3,059
       24 |      92      113      441      471      445      396      269      220      352    2,799
       25 |      93      137      439      463      431      385      230      167      255    2,600
       26 |     109       76      340      323      264      243      167      126      197    1,845
       27 |      75       81      294      308      281      231      179      122      131    1,702
       28 |     104      124      290      288      256      245      153      116      149    1,725
       29 |     111      105      375      391      268      264      183      132      110    1,939
       30 |     103      127      408      301      306      260      144       87      108    1,844
       31 |     114      109      409      366      334      278      162      109      122    2,003
       32 |     124      151      486      434      359      277      173      104      136    2,244
       33 |     119      125      540      380      283      281      191      110      123    2,152
       34 |     100      138      597      380      315      291      201      122       99    2,243
       35 |     118      204      813      468      381      344      238      143      116    2,825
       36 |     197      325    1,335      765      657      603      308      194      191    4,575
       37 |     398      510    1,445      953      772      815      427      342      268    5,930
       38 |     412      696    1,741    1,284    1,154    1,080      549      325      223    7,464
       39 |     391    1,089    3,009    1,740    1,615    1,558      755      382      203   10,742
       40 |     398    1,572    5,383    2,599    2,367    2,515    1,162      594      407   16,997
       41 |     707    2,153    6,798    3,576    3,452    3,529    1,713      738      518   23,184
       42 |   1,056    2,713    7,845    5,314    5,045    5,291    2,648    1,185      671   31,768
       43 |   1,234    3,118    8,584    6,463    6,288    6,717    3,221    1,498      947   38,070
       44 |   1,415    3,204    8,867    7,165    7,377    7,428    3,726    1,723    1,110   42,015
       45 |     215      467    1,193    1,029    1,021    1,071      590      301      252    6,139
          | 
    Total |   8,532   18,129   56,859   41,723   41,366   43,973   24,396   16,292   19,278  270,548
----------------------------------------------------------------------------------------------------

. 
. preserve

. 
.         gen count=1 if covid_tpp_probable !=.
(23,042,674 missing values generated)

.         collapse (count) count, by(agegroup covid_tpp_probable_week)

.         *export excel using "C:\Users\EIDEDGRI\Filr\My Files\OpenSafely\Non-specific immunity\Outputs\tpp_count.xlsx", first(var) replace
.         export excel using $outdir\tpp_count.xlsx, first(var) replace
file output\tpp_count.xlsx saved

. restore

. 
. * ##### COVID antigen negative tests #####
. table covid_negtest_week agegroup, contents(count covid_negtest) row col

-------------------------------------------------------------------------------------------------------------
covid_neg |                                           RECODE of age                                          
test_week |      -1      <10   10-<18   18-<30   30-<40   40-<50   50-<60   60-<70   70-<80      80+    Total
----------+--------------------------------------------------------------------------------------------------
       REDACTED 1-4
        5 |               44       17       31       34       27       33       51       39       36      312
        6 |               34       29       51       55       48       76       80       96       80      549
        7 |               69       28       81       79       66      118      124      128       78      771
        8 |               65       32       97       81       88      129      110      128      100      830
        9 |               93       95      117      177      149      189      181      159      133    1,293
       10 |              287      181      457      443      412      474      453      516      307    3,530
       11 |              571      298      744      826      816      906      813      781      450    6,205
       12 |              358      175      647      615      602      742      677      603      484    4,903
       13 |              109       48      161      197      170      208      224      218      254    1,589
       14 |               65       32      120      202      173      210      197      275      280    1,554
       15 |               47       20       71      107      100      134      126      150      212      967
       16 |               74       33      125      156      158      198      171      228      296    1,439
       17 |               85       75    2,090    2,518    2,693    2,903    1,151      375      474   12,364
       18 |              482      643    9,172   10,914   12,212   13,718    7,459    2,546    1,089   58,235
       19 |            1,501    2,266   10,123   11,010   11,490   12,249    6,039    2,155    1,260   58,093
       20 |            1,813    2,546   11,021   12,154   12,619   13,323    6,805    2,790    2,633   65,704
       21 |            2,062    2,730   10,944   11,413   10,860   11,874    6,441    2,828    3,226   62,378
       22 |       1    2,780    2,722   11,991   11,615   10,967   12,305    6,852    4,080   10,031   73,344
       23 |            4,387    3,551   14,444   14,518   13,559   14,048    7,684    4,149    7,662   84,002
       24 |            3,766    2,743   11,097   11,198   10,395   10,616    5,973    3,388    4,422   63,598
       25 |            4,272    2,833   11,299   10,836    9,532    9,732    5,331    3,042    3,506   60,383
       26 |            3,468    2,240    7,966    8,125    7,256    7,435    4,068    2,565    4,113   47,236
       27 |            4,932    3,342   11,537   12,596   11,114   10,919    6,559    3,538    4,496   69,033
       28 |            5,821    3,724   13,061   13,992   12,490   12,857    7,561    4,276    6,108   79,890
       29 |            8,159    5,198   17,916   18,813   15,832   15,950   10,914    6,599    5,753  105,134
       30 |            8,141    4,554   16,529   17,027   13,614   13,115    8,394    4,940    3,695   90,009
       31 |            9,388    5,371   19,434   19,696   15,211   14,809    9,174    5,148    4,691  102,922
       32 |            9,538    5,591   20,268   20,095   15,320   14,799    8,883    5,018    5,059  104,571
       33 |            8,903    5,925   21,780   20,232   15,462   15,063    8,866    5,440    6,304  107,975
       34 |            9,189    6,400   23,743   21,184   16,542   16,155    9,710    5,957    6,110  114,990
       35 |            9,898    6,795   23,236   20,243   15,402   14,537    8,418    4,620    4,492  107,641
       36 |           16,895    8,776   24,972   21,942   16,248   13,774    7,659    4,092    3,372  117,730
       37 |           32,121   14,498   24,361   24,829   17,563   12,578    6,256    3,425    4,277  139,908
       38 |           31,434   24,128   20,618   22,008   16,843   11,019    4,908    2,645    3,608  137,211
       39 |           17,794   24,047   23,691   20,126   16,711   12,686    6,093    2,913    2,737  126,798
       40 |           12,426   18,168   26,307   19,169   16,426   14,236    6,618    3,288    2,998  119,636
       41 |           13,902   16,207   30,139   20,960   18,171   16,514    7,633    3,782    2,839  130,147
       42 |           17,631   15,707   31,552   23,555   19,907   17,847    8,432    3,887    2,841  141,359
       43 |           14,859   12,749   30,742   23,365   19,680   19,130    8,990    3,964    2,429  135,908
       44 |           11,322    8,861   28,836   22,526   18,706   19,168    9,311    3,993    2,326  125,049
       45 |            1,722    1,548    4,233    3,233    2,883    2,803    1,399      583      315   18,719
          | 
    Total |       1  270,507  214,926  515,805  472,864  398,518  379,579  206,789  109,347  115,578  2683914
-------------------------------------------------------------------------------------------------------------

. 
. preserve

. 
.         gen count=1 if covid_negtest !=.
(20,629,612 missing values generated)

.         collapse (count) count, by(agegroup covid_negtest_week)

.         *export excel using "C:\Users\EIDEDGRI\Filr\My Files\OpenSafely\Non-specific immunity\Outputs\negtest_count.xlsx", first(var) replace
.         export excel using $outdir\negtest_count.xlsx, first(var) replace
file output\negtest_count.xlsx saved

. restore

. 
. * ##### COVID first anytest #####
. table covid_anytest_first_week agegroup, contents(count covid_anytest_first) row col

----------------------------------------------------------------------------------------------------
covid_any |
test_firs |                                      RECODE of age                                      
t_week    |     <10   10-<18   18-<30   30-<40   40-<50   50-<60   60-<70   70-<80      80+    Total
----------+-----------------------------------------------------------------------------------------
      REDACTED 1-16
       17 |      21       19      272      339      366      432      206      181      344    2,180
       18 |     106       99    1,192    1,239    1,475    1,654      935      410      538    7,648
       19 |     167      224    1,191    1,292    1,352    1,523      774      372      478    7,373
       20 |      81      116      534      596      622      666      436      304      567    3,922
       21 |     117      106      492      461      549      528      390      310      549    3,502
       22 |     120      143      494      503      490      631      408      368      620    3,777
       23 |     187      147      584      588      576      632      368      292      439    3,813
       24 |     168      116      518      521      494      549      344      281      333    3,324
       25 |     211      150      648      649      630      592      372      277      344    3,873
       26 |     243      211      733      728      657      612      349      282      304    4,119
       27 |     248      219      678      747      697      676      469      305      363    4,402
       28 |     317      234      759      847      796      786      524      350      374    4,987
       29 |     386      280    1,049    1,117    1,027      980      743      490      437    6,509
       30 |     374      238    1,034    1,027      881      867      532      322      418    5,693
       31 |     444      282    1,167    1,213      951      980      556      367      364    6,324
       32 |     583      349    1,469    1,438    1,041    1,012      650      389      363    7,294
       33 |     593      430    1,771    1,610    1,240    1,185      719      426      352    8,326
       34 |     518      372    1,656    1,496    1,071    1,028      653      407      426    7,627
       35 |     320      302    1,336    1,139      984    1,054      606      317      450    6,508
       36 |     754      415    1,890    1,729    1,423    1,572      878      449      854    9,964
       37 |   1,290      724    1,526    1,588    1,291    1,181      690      427      798    9,515
       38 |     920      819    1,603    1,656    1,526    1,602      865      561    1,321   10,873
       39 |     373      533    1,098    1,056    1,010    1,141      599      328      565    6,703
       40 |     359      478    1,320    1,093    1,022    1,059      579      356      677    6,943
       41 |     258      350    1,160      863      858      970      511      334      648    5,952
       42 |     507      492    1,405    1,220    1,120    1,241      645      337      664    7,631
       43 |     595      539    1,663    1,292    1,181    1,252      647      332      368    7,869
       44 |     379      375    1,284    1,046      960    1,013      521      309      352    6,239
       45 |      53       57      161      125      131      143       77       37       31      815
          | 
    Total |  10,808    8,889   30,878   29,496   26,798   28,009   16,408   10,400   15,077  176,763
----------------------------------------------------------------------------------------------------

. 
. preserve

. 
.         gen count=1 if covid_anytest_first !=.
(23,136,812 missing values generated)

.         collapse (count) count, by(agegroup covid_anytest_first_week)

.         *export excel using "C:\Users\EIDEDGRI\Filr\My Files\OpenSafely\Non-specific immunity\Outputs\anytest_first_count.xlsx", first(var) replace
.         export excel using $outdir\anytest_first_count.xlsx, first(var) replace
file output\anytest_first_count.xlsx saved

. restore

. 
. * ##### COVID last anytest #####
. table covid_anytest_last_week agegroup, contents(count covid_anytest_last) row col

----------------------------------------------------------------------------------------------------
covid_any |
test_last |                                      RECODE of age                                      
_week     |     <10   10-<18   18-<30   30-<40   40-<50   50-<60   60-<70   70-<80      80+    Total
----------+-----------------------------------------------------------------------------------------
    REDACTED 1-16
       17 |      21       18      252      312      338      398      187      153      296    1,975
       18 |     102       95    1,116    1,156    1,356    1,544      879      378      418    7,044
       19 |     164      217    1,124    1,255    1,315    1,457      732      347      416    7,027
       20 |      79      107      523      571      606      649      408      255      476    3,674
       21 |     113       99      461      458      527      497      366      284      465    3,270
       22 |     116      135      468      473      453      584      369      320      548    3,466
       23 |     181      130      548      554      547      589      353      286      415    3,603
       24 |     166      109      498      501      461      523      333      270      312    3,173
       25 |     198      144      627      622      609      561      363      259      345    3,728
       26 |     240      206      701      694      620      593      328      264      269    3,915
       27 |     242      215      664      722      671      665      449      296      354    4,278
       28 |     308      231      747      815      760      753      502      341      384    4,841
       29 |     387      274    1,009    1,097      989      921      717      470      401    6,265
       30 |     368      227    1,012      992      844      838      517      320      418    5,536
       31 |     440      275    1,144    1,192      929      936      541      364      335    6,156
       32 |     584      346    1,402    1,415    1,012    1,002      616      399      354    7,130
       33 |     583      426    1,790    1,603    1,242    1,169      722      411      362    8,308
       34 |     527      377    1,673    1,530    1,079    1,040      637      409      426    7,698
       35 |     321      288    1,318    1,111      949    1,008      583      313      433    6,324
       36 |     739      427    1,846    1,685    1,403    1,505      874      448      890    9,817
       37 |   1,309      736    1,539    1,556    1,304    1,161      664      453      859    9,581
       38 |     949      844    1,656    1,735    1,600    1,668      940      619    1,442   11,453
       39 |     390      568    1,189    1,127    1,099    1,284      688      405      665    7,415
       40 |     365      484    1,387    1,179    1,124    1,161      652      397      753    7,502
       41 |     261      358    1,232      928      943    1,061      581      381      732    6,477
       42 |     502      504    1,491    1,297    1,204    1,380      717      373      759    8,227
       43 |     604      540    1,738    1,387    1,256    1,357      700      363      428    8,373
       44 |     384      379    1,375    1,129    1,058    1,123      578      342      441    6,809
       45 |      55       61      173      137      149      160       85       44       41      905
          | 
    Total |  10,808    8,889   30,878   29,496   26,798   28,009   16,409   10,401   15,078  176,766
----------------------------------------------------------------------------------------------------

. 
. preserve

. 
.         gen count=1 if covid_anytest_last !=.
(23,136,812 missing values generated)

.         collapse (count) count, by(agegroup covid_anytest_last_week)

.         *export excel using "C:\Users\EIDEDGRI\Filr\My Files\OpenSafely\Non-specific immunity\Outputs\anytest_last_count.xlsx", first(var) replace
.         export excel using $outdir\anytest_last_count.xlsx, first(var) replace
file output\anytest_last_count.xlsx saved

. restore

. 
. 
. log close
      name:  <unnamed>
       log:  E:\cohorts\non-specific-immunity-research\log/00_Test_runs_and_feasibility.log
  log type:  text
 closed on:  13 Nov 2020, 12:47:30
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
